<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç¦å¡ - æè‡´çµæ•ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Long+Cang&family=Zhi+Mang+Xing&family=Liu+Jian+Mao+Cao&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; padding: 0; background: #0a0a0a url('assets/default_bg.jpg') no-repeat center/cover fixed;
            overflow: hidden; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center;
        }
        #status-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: #ffd700; padding: 12px 28px;
            border-radius: 30px; z-index: 1000; border: 1px solid rgba(255,215,0,0.4);
            backdrop-filter: blur(8px); pointer-events: none; font-family: sans-serif;
        }
        #app { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .card {
            position: absolute; width: 15vw; height: 21vw; max-width: 100px; max-height: 140px;
            background: #d62f2f; border: 2.5px solid #ffd700; border-radius: 12px; color: #ffd700;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6); pointer-events: none; will-change: transform;
        }
        #main-card {
            position: absolute; width: 85vw; height: 75vh; max-width: 460px; max-height: 660px;
            background: radial-gradient(circle, #e62e2e, #8b0000);
            border: 8px double #ffd700; border-radius: 20px; display: none; z-index: 100;
            box-shadow: 0 0 80px rgba(0,0,0,0.8);
            animation: cardFadeIn 0.3s ease-out;
        }
        @keyframes cardFadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .fu-main { position: absolute; right: 10%; top: 50%; transform: translateY(-50%); font-size: 200px; color: #ffd700; }
        .fu-name { position: absolute; left: 10%; top: 50%; transform: translateY(-50%); writing-mode: vertical-rl; font-size: 80px; color: #ffd700; border-right: 2px solid rgba(255,215,0,0.5); padding-right: 20px; }
        #v-h { position: absolute; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>

<video id="v-h" playsinline></video>
<div id="status-bar">èµ„æºåŠ è½½ä¸­...</div>
<div id="app">
    <div id="ring"></div>
    <div id="main-card">
        <div id="target-name" class="fu-name">é¡ºè„‰ç¦</div>
        <div id="target-main" class="fu-main">ç¦</div>
    </div>
</div>

<script>
    const video = document.getElementById('v-h');
    const status = document.getElementById('status-bar');
    const ring = document.getElementById('ring');
    const mainCard = document.getElementById('main-card');
    
    let isMerged = false, cards = [];
    let autoRotation = 0;
    let handRotationOffset = 0;
    let targetHandRotation = 0;
    let currentScale = 1.0, targetScale = 1.0;
    
    // åˆ·æ–°å¢å¼ºï¼šç¦»åœºè®¡æ•°å™¨
    let lostFrames = 0;
    const RESET_THRESHOLD = 15; // è¿ç»­ 15 å¸§æ¶ˆå¤±åˆ™é‡ç½®

    const fontPool = ["'Ma Shan Zheng'", "'Long Cang'", "'Zhi Mang Xing'", "'Liu Jian Mao Cao'"];
    const fuNames = ["é¡ºè„‰ç¦", "å–œå¨©ç¦", "åº·ä¹ç¦", "å¥éª¨ç¦", "æ˜çœ¼ç¦", "æ´é½¿ç¦", "é€Ÿå®‰ç¦", "è°ƒè¡¡ç¦", "æ¸…ç¥ç¦", "åº·æ„ˆç¦"];

    function initRing() {
        ring.innerHTML = ''; cards = [];
        for (let i = 0; i < 8; i++) {
            const el = document.createElement('div');
            el.className = 'card'; el.innerHTML = 'ç¦';
            el.style.fontFamily = fontPool[Math.floor(Math.random() * fontPool.length)];
            el.style.fontSize = `${Math.floor(Math.random() * 15) + 55}px`;
            ring.appendChild(el);
            cards.push({ 
                el, 
                orbitAngle: (i / 8) * Math.PI * 2,
                selfOffset: (Math.random() - 0.5) * 0.2 
            });
        }
    }

    const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    hands.setOptions({ modelComplexity: 0, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

    hands.onResults((res) => {
        // --- æ ¸å¿ƒï¼šæ£€æµ‹æ‰‹éƒ¨æ˜¯å¦ç¦»åœº ---
        if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) {
            lostFrames++;
            if (isMerged && lostFrames > RESET_THRESHOLD) {
                console.log("æ£€æµ‹åˆ°æ‰‹éƒ¨ç¦»åœºï¼Œé‡ç½®ç³»ç»Ÿ");
                resetGame();
            }
            status.innerText = isMerged ? "ğŸ‘‹ æ”¾ä¸‹æ‰‹æˆ–å¼ å¼€æ‰‹å³å¯åˆ·æ–°" : "ğŸ‘‹ è¯·ä¸¾æ‰‹æ§åˆ¶";
            targetScale = 1.0; 
            targetHandRotation = 0;
            return;
        }

        // è¯†åˆ«åˆ°æ‰‹ï¼Œé‡ç½®è®¡æ•°å™¨
        lostFrames = 0;
        const lms = res.multiHandLandmarks[0];
        
        // æ‰‹æŒå…¬è½¬/è‡ªè½¬åŒæ­¥
        targetHandRotation = Math.atan2(lms[9].y - lms[0].y, lms[9].x - lms[0].x) + Math.PI/2;

        const dist = Math.hypot(lms[4].x - lms[8].x, lms[4].y - lms[8].y);
        
        if (!isMerged) {
            let s = (dist - 0.05) / 0.22;
            targetScale = Math.min(Math.max(s, 0.08), 1.0);
            status.innerText = "ğŸ¯ æåˆèšæ‹¢...";
            if (targetScale < 0.11) triggerMerge();
        } else {
            // äº”æŒ‡å¼ å¼€åˆ·æ–°é€»è¾‘ï¼ˆåŒé‡ä¿é™©ï¼‰
            const openDist = Math.hypot(lms[4].x - lms[20].x, lms[4].y - lms[20].y);
            status.innerText = "âœ¨ å¼ å¼€æ‰‹æŒæˆ–æ”¶å›æ‰‹å³å¯åˆ·æ–°";
            if (openDist > 0.45) resetGame();
        }
    });

    const camera = new Camera(video, {
        onFrame: async () => { await hands.send({image: video}); },
        width: 1280, height: 720
    });

    function triggerMerge() {
        if (isMerged) return;
        isMerged = true;
        cards.forEach(c => c.el.style.display = 'none');
        const idx = Math.floor(Math.random() * fuNames.length);
        const targetFont = fontPool[Math.floor(Math.random() * fontPool.length)];
        
        document.getElementById('target-name').innerText = fuNames[idx];
        document.getElementById('target-name').style.fontFamily = targetFont;
        document.getElementById('target-main').style.fontFamily = targetFont;

        const img = new Image();
        img.src = `assets/bg_${idx + 1}.jpg`;
        img.onload = () => document.body.style.backgroundImage = `url('${img.src}')`;
        img.onerror = () => document.body.style.backgroundImage = "url('assets/default_bg.jpg')";
        mainCard.style.display = 'block';
    }

    function resetGame() {
        if (!isMerged && targetScale === 1.0) return; // é¿å…é‡å¤é‡ç½®
        isMerged = false;
        targetScale = 1.0;
        lostFrames = 0;
        mainCard.style.display = 'none';
        document.body.style.backgroundImage = "url('assets/default_bg.jpg')";
        initRing();
    }

    function animate() {
        if (!isMerged) {
            autoRotation += 0.008; // åŸºç¡€å¹³æ»‘å…¬è½¬

            let diff = targetHandRotation - handRotationOffset;
            while (diff < -Math.PI) diff += Math.PI * 2;
            while (diff > Math.PI) diff -= Math.PI * 2;
            handRotationOffset += diff * 0.1;

            currentScale += (targetScale - currentScale) * 0.12;
            const totalRotation = autoRotation + handRotationOffset;
            const radius = Math.min(window.innerWidth, window.innerHeight) * 0.38 * currentScale;
            
            cards.forEach(c => {
                const orbitA = c.orbitAngle + totalRotation;
                const x = Math.cos(orbitA) * radius;
                const y = Math.sin(orbitA) * radius;
                // è‡ªè½¬è·Ÿéšè½¨é“è§’åº¦
                const selfRot = orbitA + 1.57 + c.selfOffset;
                c.el.style.transform = `translate(${x}px, ${y}px) rotate(${selfRot}rad)`;
            });
        }
        requestAnimationFrame(animate);
    }

    window.onload = () => {
        initRing(); animate();
        status.innerText = "ğŸ‘† ç‚¹å‡»å±å¹•å¯åŠ¨ AI";
        document.body.onclick = () => {
            camera.start().then(() => status.innerText = "âœ… å·²å°±ç»ª (ç¦»åœºæˆ–å¼ å¼€æ‰‹å¯åˆ·æ–°)");
        };
    };
</script>
</body>
</html>
